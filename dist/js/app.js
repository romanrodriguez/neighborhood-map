"use strict";function initMap(){map=new google.maps.Map(document.getElementById("map"),{center:{lat:37.5087133,lng:-122.2945044},zoom:10,styles:styles,mapTypeControl:!1}),google.maps.event.addDomListener(window,"resize",function(){var a=map.getCenter();google.maps.event.trigger(map,"resize"),map.setCenter(a)});var b=(new google.maps.places.Autocomplete(document.getElementById("search-within-time-text")),new google.maps.places.Autocomplete(document.getElementById("zoom-to-area-text")));b.bindTo("bounds",map);var c=new google.maps.places.SearchBox(document.getElementById("places-search"));c.setBounds(map.getBounds());for(var d=[{title:"Golden Gate Bridge",location:{lat:37.819929,lng:-122.478255}},{title:"Googleplex",location:{lat:37.422,lng:-122.084057}},{title:"Udacity",location:{lat:37.399864,lng:-122.1084}},{title:"Chinatown",location:{lat:37.794138,lng:-122.407791}},{title:"Muir Woods",location:{lat:37.895369,lng:-122.578071}}],e=new google.maps.InfoWindow,f=new google.maps.drawing.DrawingManager({drawingMode:google.maps.drawing.OverlayType.POLYGON,drawingControl:!0,drawingControlOptions:{position:google.maps.ControlPosition.TOP_LEFT,drawingModes:[google.maps.drawing.OverlayType.POLYGON]}}),g=makeMarkerIcon("0091ff"),h=makeMarkerIcon("FFFF24"),i=0;i<d.length;i++){var j=d[i].location,k=d[i].title,l=new google.maps.Marker({position:j,title:k,animation:google.maps.Animation.DROP,icon:g,id:i});markers.push(l),l.addListener("click",function(){populateInfoWindow(this,e)}),l.addListener("mouseover",function(){this.setIcon(h)}),l.addListener("mouseout",function(){this.setIcon(g)})}document.getElementById("show-listings").addEventListener("click",showListings),document.getElementById("hide-listings").addEventListener("click",function(){hideMarkers(markers)}),document.getElementById("toggle-drawing").addEventListener("click",function(){toggleDrawing(f)}),document.getElementById("zoom-to-area").addEventListener("click",function(){zoomToArea()}),document.getElementById("search-within-time").addEventListener("click",function(){searchWithinTime()}),c.addListener("places_changed",function(){searchBoxPlaces(this)}),document.getElementById("go-places").addEventListener("click",textSearchPlaces),f.addListener("overlaycomplete",function(a){polygon&&(polygon.setMap(null),hideMarkers(markers)),f.setDrawingMode(null),polygon=a.overlay,polygon.setEditable(!0),searchWithinPolygon(polygon),polygon.getPath().addListener("set_at",searchWithinPolygon),polygon.getPath().addListener("insert_at",searchWithinPolygon)})}function populateInfoWindow(a,b){function e(c,d){if(d==google.maps.StreetViewStatus.OK){var e=c.location.latLng,f=google.maps.geometry.spherical.computeHeading(e,a.position);b.setContent("<div>"+a.title+'</div><div id="pano"></div>');var g={position:e,pov:{heading:f,pitch:30}};new google.maps.StreetViewPanorama(document.getElementById("pano"),g)}else b.setContent("<div>"+a.title+"</div><div>No Street View Found</div>")}if(b.marker!=a){b.setContent(""),b.marker=a,b.addListener("closeclick",function(){b.marker=null});var c=new google.maps.StreetViewService,d=50;c.getPanoramaByLocation(a.position,d,e),b.open(map,a)}}function showListings(){for(var a=new google.maps.LatLngBounds,b=0;b<markers.length;b++)markers[b].setMap(map),a.extend(markers[b].position);map.fitBounds(a)}function hideMarkers(a){for(var b=0;b<a.length;b++)a[b].setMap(null)}function makeMarkerIcon(a){var b=new google.maps.MarkerImage("http://chart.googleapis.com/chart?chst=d_map_spin&chld=1.15|0|"+a+"|40|_|%E2%80%A2",new google.maps.Size(21,34),new google.maps.Point(0,0),new google.maps.Point(10,34),new google.maps.Size(21,34));return b}function toggleDrawing(a){a.map?(a.setMap(null),null!==polygon&&polygon.setMap(null)):a.setMap(map)}function searchWithinPolygon(){for(var a=0;a<markers.length;a++)google.maps.geometry.poly.containsLocation(markers[a].position,polygon)?markers[a].setMap(map):markers[a].setMap(null)}function zoomToArea(){var a=new google.maps.Geocoder,b=document.getElementById("zoom-to-area-text").value;""==b?window.alert("You must enter an area, or address."):a.geocode({address:b,componentRestrictions:{locality:"San Francisco"}},function(a,b){b==google.maps.GeocoderStatus.OK?(map.setCenter(a[0].geometry.location),map.setZoom(15)):window.alert("We could not find that location - try entering a more specific place.")})}function searchWithinTime(){var a=new google.maps.DistanceMatrixService,b=document.getElementById("search-within-time-text").value;if(""==b)window.alert("You must enter an address.");else{hideMarkers(markers);for(var c=[],d=0;d<markers.length;d++)c[d]=markers[d].position;var e=b,f=document.getElementById("mode").value;a.getDistanceMatrix({origins:c,destinations:[e],travelMode:google.maps.TravelMode[f],unitSystem:google.maps.UnitSystem.IMPERIAL},function(a,b){b!==google.maps.DistanceMatrixStatus.OK?window.alert("Error was: "+b):displayMarkersWithinTime(a)})}}function displayMarkersWithinTime(a){for(var b=document.getElementById("max-duration").value,c=a.originAddresses,e=(a.destinationAddresses,!1),f=0;f<c.length;f++)for(var g=a.rows[f].elements,h=0;h<g.length;h++){var i=g[h];if("OK"===i.status){var j=i.distance.text,k=i.duration.value/60,l=i.duration.text;if(k<=b){markers[f].setMap(map),e=!0;var m=new google.maps.InfoWindow({content:l+" away, "+j+'<div><input type="button" value="View Route" onclick ="displayDirections(&quot;'+c[f]+'&quot;);"></input></div>'});m.open(map,markers[f]),markers[f].infowindow=m,google.maps.event.addListener(markers[f],"click",function(){this.infowindow.close()})}}}e||window.alert("We could not find any locations within that distance!")}function displayDirections(a){hideMarkers(markers);var b=new google.maps.DirectionsService,c=document.getElementById("search-within-time-text").value,d=document.getElementById("mode").value;b.route({origin:a,destination:c,travelMode:google.maps.TravelMode[d]},function(a,b){if(b===google.maps.DirectionsStatus.OK){new google.maps.DirectionsRenderer({map:map,directions:a,draggable:!0,polylineOptions:{strokeColor:"green"}})}else window.alert("Directions request failed due to "+b)})}function searchBoxPlaces(a){hideMarkers(placeMarkers);var b=a.getPlaces();0==b.length?window.alert("We did not find any places matching that search!"):createMarkersForPlaces(b)}function textSearchPlaces(){var a=map.getBounds();hideMarkers(placeMarkers);var b=new google.maps.places.PlacesService(map);b.textSearch({query:document.getElementById("places-search").value,bounds:a},function(a,b){b===google.maps.places.PlacesServiceStatus.OK&&createMarkersForPlaces(a)})}function createMarkersForPlaces(a){for(var b=new google.maps.LatLngBounds,c=0;c<a.length;c++){var d=a[c],e={url:d.icon,size:new google.maps.Size(35,35),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(15,34),scaledSize:new google.maps.Size(25,25)},f=new google.maps.Marker({map:map,icon:e,title:d.name,position:d.geometry.location,id:d.place_id}),g=new google.maps.InfoWindow;f.addListener("click",function(){g.marker==this?console.log("This infowindow already is on this marker!"):getPlacesDetails(this,g)}),placeMarkers.push(f),d.geometry.viewport?b.union(d.geometry.viewport):b.extend(d.geometry.location)}map.fitBounds(b)}function getPlacesDetails(a,b){var c=new google.maps.places.PlacesService(map);c.getDetails({placeId:a.id},function(c,d){if(d===google.maps.places.PlacesServiceStatus.OK){b.marker=a;var e="<div>";c.name&&(e+="<strong>"+c.name+"</strong>"),c.formatted_address&&(e+="<br>"+c.formatted_address),c.formatted_phone_number&&(e+="<br>"+c.formatted_phone_number),c.opening_hours&&(e+="<br><br><strong>Hours:</strong><br>"+c.opening_hours.weekday_text[0]+"<br>"+c.opening_hours.weekday_text[1]+"<br>"+c.opening_hours.weekday_text[2]+"<br>"+c.opening_hours.weekday_text[3]+"<br>"+c.opening_hours.weekday_text[4]+"<br>"+c.opening_hours.weekday_text[5]+"<br>"+c.opening_hours.weekday_text[6]),c.photos&&(e+='<br><br><img src="'+c.photos[0].getUrl({maxHeight:100,maxWidth:200})+'">'),e+="</div>",b.setContent(e),b.open(map,a),b.addListener("closeclick",function(){b.marker=null})}})}function startMap(){initMap(),ko.applyBindings(new mapViewModel)}function googleError(){document.getElementById("map").innerHTML='<div class="map-error">Google Maps is unavailable. Please try again later.</div>'}var map,markers=[],polygon=null,placeMarkers=[],FOURSQUARE_URL="https://api.foursquare.com/v2/venues/explore?client_id=ELY3E2TUMOBQYW2RNN3PAFUPSK0MXYYH35YHUCHNLKE1RSNX&client_secret=MZYLG135WRNP2ETN4PMEXVFNPEWWTQLIR4ODFO5CBJK0KLXD",FOURSQUARE_SETTINGS={ll:"37.4419, -122.1430",limit:50,section:"topPicks",v:"20160903",m:"foursquare"},VenueModel=function(a){var b=a.venue.location.lat,c=a.venue.location.lng;this.position=new google.maps.LatLng(b,c),this.name=ko.observable(a.venue.name),this.address=a.venue.location.formattedAddress||"",this.marker=new google.maps.Marker({map:map,position:this.position,title:name,animation:google.maps.Animation.DROP})};VenueModel.prototype.bounce=function(){var a;a=this.hasOwnProperty("marker")?this.marker:this,a.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){a.setAnimation(null)},1e3)},VenueModel.prototype.info=function(){var a="<div>"+this.name()+"</div><div>"+this.address,b=new google.maps.InfoWindow;b.setContent(a),b.open(map,this.marker),this.marker.largeInfowindow.close()},VenueModel.prototype.animate=function(){this.bounce(),this.info()};var mapViewModel=function(){var a=this;a.venues=ko.observableArray([]),a.keyword=ko.observable(""),a.foursquareVenues=ko.observableArray([]),$.getJSON(FOURSQUARE_URL,FOURSQUARE_SETTINGS).done(function(b){a.foursquareVenues(b.response.groups[0].items),a.bounds=new google.maps.LatLngBounds;for(var c=0;c<a.foursquareVenues().length;c++){var d=new VenueModel(a.foursquareVenues()[c]);a.venues.push(d),a.bounds.extend(d.position),map.fitBounds(a.bounds),map.setCenter(a.bounds.getCenter())}}).fail(function(a,b,c){alert("We couldn't reach the Forsquare API. Please, try again later.")}),a.showVenues=ko.computed(function(){return a.venues().filter(function(b){return b.name().toLowerCase().indexOf(a.keyword().toLowerCase())>-1?(b.marker.setMap(map),b.marker.addListener("click",function(){map.panTo(b.position),b.animate()}),!0):(b.marker.setMap(null),!1)})})};